/*! Leverage.js - v0.0.2 - 2013-04-30
* Copyright (c) 2013 Phil Burrows; Licensed MIT */
(function(e){(function(){var e={classMethods:{before:function(e,t){var n=this.prototype[e];this.prototype[e]=_.extend(function(){return t.apply(this,arguments),n.apply(this,arguments)},n)},after:function(e,t){var n=this.prototype[e];this.prototype[e]=_.extend(function(){var e=n.apply(this,arguments);return t.apply(this,arguments),e},n)}}};this.Leverage.Callbacks=e}).call(this),function(){var e=function(){this.__initialize!==void 0&&this.__initialize.apply(this,arguments),this.initialize!==void 0&&this.initialize.apply(this,arguments)};e.prototype.__initialize=function(){this.setAttrs.apply(this,arguments)},e.prototype.setAttrs=function(e){if("object"==typeof e)for(var t in e)this[t]=e[t]},e.prototype.super=function(e){this.constructor.__super[e]!==void 0&&this.constructor.__super[e].apply(this,Array.prototype.slice.call(arguments,1))},e.extend=function(e,t){var n,r=this;n=function(){r.apply(this,arguments)},_.extend(n,r);var i=function(){this.constructor=n};i.prototype=r.prototype,n.prototype=new i,e&&_.extend(n.prototype,e),t&&_.extend(n,t);var o,a=this.prototype.__initialize;e&&(o=e.__initialize),!o&&t&&(o=t.__initialize);var s;return o&&(s=function(){o&&o.apply(this,arguments),a&&a.apply(this,arguments)}),n.prototype.__initialize=s||r.prototype.__initialize,n.__super=r.prototype,n},this.Leverage.Class=e}.call(this),function(){var t=Leverage.Class.extend({__initialize:function(){var t=this;if(this.events=this.events||{},this.__handlers={},this.el){"string"==typeof this.el&&(this.el=e(this.el)),this.events.length;for(var n in this.events){var r=n.split(/\s+/),i=[];if("string"!=typeof this.events[n])for(var o=this.events[n].length-1;o>=0;o--)i.push(this[this.events[n][o]]);else i.push(this[this.events[n]]);this.__handlers[n]=this.__handlers[n]||[];for(var a=i.length-1;a>=0;a--)this.__handlers[n].push(i[a]);this.el.delegate(r[0],r[1],function(e){for(var n=i.length,r=0;n>r;r++)i[r].call(t,e,this)})}}},html:function(e){return this.el?this.el.html(e):void 0}});this.Leverage.Controller=t}.call(this),function(){var e={instanceMethods:{_bindings:{},bind:function(e,t){return this._bindings[e]=this._bindings[e]||[],this._bindings[e].push(t),this},__initialize:function(){var e=this;for(var t in this)if(this[t]!==void 0&&this[t].__boundProperties)for(var n=this[t].__boundProperties.length-1;n>=0;n--)(function(t,n){this.bind("change:"+this[t].__boundProperties[n],function(){e.trigger("change:"+t)})}).call(this,t,n)},isBound:function(e,t){for(var n=this._bindings.length-1;n>=0;n--)if(this._bindings[n]===t)return!0;return!1},trigger:function(e,t){var n=this._bindings[e];if(n!==void 0)for(var r=n.length,i=0;r>i;i++)n[i].call(this,t);return this}}};e.fire=e.trigger,e.on=e.bind,this.Leverage.Events=e}.call(this),function(){var e={};e.noop=function(){},e.bind=function(e,t){return function(){return e.apply(t,arguments)}},e.bindLeverageFunctions=function(t){for(var n in t)/^_leverage/.test(n)&&[n].apply&&(console.log("binding: "+n),t[n]=e.bindContext(t[n],t))},this.Leverage=e}.call(this),function(){var e=function(){var e=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()},t=function(e){var t,n=/^(.*)(\((.*)\))$/;return null==e?!1:(t=e.match(n))?{name:t[1],arg:t[3]}:!1},n=Leverage.Class.extend({__initialize:function(){this.super("initialize",arguments),Leverage.bindLeverageFunctions(this),this._leverageID=this._leverageID||e()},set:function(e,t,n){null==n&&(n=!0);var r=e[0].toUpperCase()+e.slice(1);return this["set"+r]?this["set"+r](t):this[e]=t,n&&this.trigger("change:"+e,this.get(e)),this},get:function(e){var n,r;if(0>e.indexOf(".")&&0>e.indexOf("("))return this[e];if(!(n=t(e))){for(var i,o=e.split("."),a=this,s=0;o.length>s;s++)void 0!==a&&((n=t(o[s]))?(i=a[n.name],a=i!==void 0?n.arg&&""!==n.arg?i.call(a,n.arg):i.call(a):i):a=a[o[s]]);return a}return r=this.get.call(this,n.name),r!==void 0?""!==n.arg?r.call(this,n.arg):r.call(this):void 0}});n.include(Leverage.Events),n.include(Leverage.Validations),n.include(Leverage.Callbacks),this.Leverage.Model=n}.call(this),function(){var t,n=null!=(null!=(t=window.history)?t.pushState:void 0),r=function(e){var t=document.createElement("a");t.href=e,this.queryString=t.search.replace(/^\?/,""),this.hash=t.hash.replace(/^#/,""),this.path=t.pathname,this.fullPathWithoutHash=this.path+(this.queryString.length>0?"?"+this.queryString:""),this.fullPath=this.fullPathWithoutHash+(this.hash.length>0?"#"+this.hash:""),this.queryParams={};for(var n,r=/\+/g,i=/([^&=]+)=?([^&]*)/g,o=function(e){return decodeURIComponent(e.replace(r," "))},a=this.queryString;n=i.exec(a);)this.queryParams[o(n[1])]=o(n[2])},i=function(t,n,i,o){var a=new r(t);this.url=a,this.path=a.path,this.queryString=a.queryString,this.queryParams=a.queryParams,this.fullPath=a.fullPath,this.method=n||"GET",this.body=i;var s=this.path.split("/");this.pathPieces=""===s[0]?s.slice(1):s;var l=o.findRoute(this.path);this.pathParams=l?o.pathParams(this.path,l):{},this.params=e.extend({},this.pathParams,this.queryParams),this.perform=function(){l&&(o.trigger("request:before"),l.handler(this),o.trigger("request"))}},o=function(t){null==t&&(t={}),this.options=e.extend({},{pushState:!0,test:!1},t),this.usePushState=this.options.pushState&&n;var o,a=this,s=[];this.updateUrl=function(e){var t=new r(e);return this.usePushState?history.pushState({},document.title,t.fullPath):window.location.hash=t.fullPathWithoutHash},this.createRequest=function(e,t,n){var r=new i(e,t,n,this);r.perform()},this.goTo=function(e){this.options.test?this.handleUrlChange(e):this.updateUrl(e)},this.navigate=this.goTo,this.handleUrlChange=function(e){if(this.usePushState)null==e&&(e=document.location),this.createRequest(new r(e).fullPath);else{var t=new r(e||document.location),n=null==e?t.hash:t.fullPathWithoutHash;this.createRequest(n)}},this.pushDefaultRoute=function(){o&&this.goTo(o)},this.setDefault=function(e){o=e},this.addRoute=function(e){s.push(e)},this.routes=function(){return s},this.findRoute=function(e){for(var t=0;s.length>t;t++)if(s[t].matcher.test(e))return s[t];return!1},this.pathParams=function(e,t){for(var n={},r=e.match(t.matcher),i=t.params.length-1;i>=0;i--)n[t.params[i]]=r[i+1];return n},this.options.test||(this.usePushState?e(window).bind("popstate",function(){a.handleUrlChange()}):e(window).bind("hashchange",function(){a.handleUrlChange()})),e(document).ready(function(){var t=new r(document.location);a.usePushState?t.path&&"/"!==t.path?e(window).trigger("popstate"):a.pushDefaultRoute():t.hash&&"/"!==t.hash?e(window).trigger("hashchange"):a.pushDefaultRoute()})};o.prototype.catchAll=function(e){return this.addRoute({matcher:/.*/,params:[],handler:e}),this},o.prototype.define=function(e,t){var n=/:([^:]+)/,r=e.split("/"),i=[];e=e.replace(/^\/+/,"");for(var o=0;r.length>o;o++){var a;(a=r[o].match(n))&&(r[o]="([^\\/]+)",i.push(a[1]))}var s=RegExp("^"+r.join("\\/")+"/?$");return this.addRoute({matcher:s,params:i,handler:t}),this},o.prototype.resources=function(e,t,n){null==n&&(n={});var r=this;if(/\//.test(e)){for(var i=e.split("/"),o=0;i.length>o;o++)o+1!==i.length&&(i[o]=i[o]+"/:"+i[o].slice(0,-1)+"_id");e=i.join("/")}e="/"+e;for(var a in t)"show"===a?r.define(e+"/:id",t[a]):"index"===a?r.define(e,t[a]):"edit"===a?r.define(e+"/:id/edit",t[a]):"update"===a?r.define(e+"/:id/update",t[a]):"delete"===a&&r.define(e+"/:id/delete",t[a]);return this},o.include(Leverage.Events),this.Leverage.Router=o}.call(this),function(){var t=/.^/,n={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var r in n)n[n[r]]=r;var i=/\\|'|\r|\n|\t|\u2028|\u2029/g,o=/\\(\\|'|r|n|t|u2028|u2029)/g,a=function(e){return e.replace(o,function(e,t){return n[t]})},s=function(e,t){e=a(e).replace(/^\s+|\s+$/g,"");var n,r=e.split("."),i=r[r.length-1];n=1===r.length?t.variable||"obj":r.length>2?r.slice(0,r.length-2).join("."):r[0];var o=!1,s=/\(\)\s*$/;return s.test(i)&&(o=!0,i=i.replace(s,"")),{obj:n,val:i,isFunc:o,code:e}},l=function(e,r,o){o=_.defaults(o||{},l.settings);var u="__p+='"+e.replace(i,function(e){return"\\"+n[e]}).replace(o.bind||t,function(e,t){var n=s(t,o),r="'+\n__bind("+n.obj+", '"+n.val+"',"+n.isFunc+")+\n";return r+="'<span class=\"' + __className("+n.obj+",'"+n.val+"') + '\">'+("+a(n.code)+")+'</span>'+\n'"}).replace(o.modelBind||t,function(e,t){var n=s(t,o),r=n.val.split(/\s*:\s*/),i=r.length>1?r[1]:"onchange";/^on/.test(i)||(i="on"+i),n.val=r[0],t=t.split(/\s*:\s*/)[0];var l="'+\n__boundModel("+n.obj+")+\n'";return l+="'+\n("+a(t)+")+'\" "+i+"=\"Leverage.Template.onInputChange(\\'' + __binderId("+n.obj+",'"+n.val+"') + '\\', this)'+\n'"}).replace(o.escape||t,function(e,t){return"'+\n_.escape("+a(t)+")+\n'"}).replace(o.interpolate||t,function(e,t){return"'+\n("+a(t)+")+\n'"}).replace(o.evaluate||t,function(e,t){return"';\n"+a(t)+"\n;__p+='"})+"';\n";o.variable||(u="with(obj||{}){\n"+u+"}\n"),u="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\nvar __binderId=function(binder, attr){ return binder._leverageID + '-' + attr.replace(/()s*$/, ''); };var __className=function(binder, attr){ return 'data-bind-'+__binderId(binder,attr); };var __bind=function(binder, attr, isFunc){ var c=__className(binder,attr); if(!Leverage.Template.allBindings[c]){ binder.bind('change:'+attr, function(newVal){var h = $('.'+c); if(isFunc){ h.text(binder[attr]()); }else{ h.text(newVal); } }); Leverage.Template.allBindings[c]=true; } return''; };\nvar __boundModel=function(m){ if(!Leverage.Template.boundModels[m._leverageID]) Leverage.Template.boundModels[m._leverageID] = m; return ''; };"+u+"return __p;\n";var c=Function(o.variable||"obj","_",u);if(r)return c(r,_);var h=function(e){return c.call(this,e,_)};return h.source="function("+(o.variable||"obj")+"){\n"+u+"}",h};l.settings={interpolate:/\{=(.+?)=\}/g,escape:/\{==(.+?)==\}/g,evaluate:/\{%(.+?)%\}/g,bind:/\{=>(.+?)<=\}/g,modelBind:/\{<=(.+?)=>\}/g,twoWayBind:/\{<=>(.+?)<=>\}/g},l.onInputChange=function(t,n){var r=t.split("-"),i=r[0],o=r[1],a=l.boundModels[i],s=e(n).val();a&&a.set(o,s)},l.allBindings={},l.boundModels={},this.Leverage.Template=l}.call(this),function(){Function.prototype.include=function(){for(var e=0;arguments.length>e;e++){var t=this.prototype.__initialize,n=arguments[e].__initialize;n||(n=arguments[e].instanceMethods?arguments[e].instanceMethods.__initialize:null),n||(n=arguments[e].classMethods?arguments[e].classMethods.__initialize:null);var r;n&&(r=function(){n&&n.apply(this,arguments),t&&t.apply(this,arguments)}),arguments[e].instanceMethods?_.extend(this.prototype,arguments[e].instanceMethods):_.extend(this.prototype,arguments[e]),arguments[e].classMethods&&_.extend(this,arguments[e].classMethods),this.prototype.__initialize=r||this.prototype.__initialize}return this},Function.prototype.boundTo=function(){var e=this,t=function(){return e.apply(this,arguments)};return t.__boundProperties=Array.prototype.slice.call(arguments,0),t}}.call(this),function(){var e=function(e){this.errors=e||[]};e.prototype.blank=function(){return 0===this.errors.length},e.prototype.add=function(e,t){this.errors.push({attribute:e,message:t})};var t={instanceMethods:{getErrors:function(){return this._leverageErrors=this._leverageErrors||new e,this._leverageErrors},isValid:function(){return this.validate(),this.getErrors().blank()},validate:function(){this._leverageErrors=new e,this._leverageValidations=this._leverageValidations||{};var t=this._leverageValidations;for(var n in t)for(var r=t[n].length-1;r>=0;r--)t[n][r].call(this)},_leverageAddError:function(e,t){this.getErrors().add(e,t)}},classMethods:{validatesPresenceOf:function(e,t){t=t||"cannot be blank",n.call(this,e,t,function(){return this[e]===void 0||""===this[e]})},validatesLengthOf:function(e,t,r){r=r||"must be at least "+t+" characters in length",n.call(this,e,r,function(){return!this[e]||t>this[e].length})},__clearValidations:function(){this.prototype._leverageValidations={}}}},n=function(e,t,n){this.prototype._leverageValidations=this.prototype._leverageValidations||{},this.prototype._leverageValidations[e]=this.prototype._leverageValidations[e]||[],this.prototype._leverageValidations[e].push(function(){n.call(this)&&this._leverageAddError(e,t)})};this.Leverage.Validations=t}.call(this)}).call(this,$);